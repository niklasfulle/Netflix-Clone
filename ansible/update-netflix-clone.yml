---
- name: Update Netflix Clone Docker Container
  hosts: netflix
  gather_facts: no
  vars:
    docker_compose_path: "/root/netflix-clone"
    docker_registry: "salkin263"
    image_name: "netflix-clone"
  
  tasks:
    - name: Read version from local version.txt
      delegate_to: localhost
      slurp:
        src: "../version.txt"
      register: version_file

    - name: Set version variable
      set_fact:
        app_version: "{{ (version_file.content | b64decode).strip() }}"

    - name: Display version to update
      debug:
        msg: "Updating to version {{ app_version }}"

    - name: Ensure docker-compose directory exists
      file:
        path: "{{ docker_compose_path }}"
        state: directory
        mode: '0755'

    - name: Copy docker-compose.yml to remote host
      template:
        src: docker-compose.yml.j2
        dest: "{{ docker_compose_path }}/docker-compose.yml"
        mode: '0644'
      register: compose_file

    - name: Stop and remove existing container
      community.docker.docker_compose:
        project_src: "{{ docker_compose_path }}"
        state: absent
      ignore_errors: yes

    - name: Pull new Docker image
      community.docker.docker_image:
        name: "{{ docker_registry }}:{{ image_name }}:{{ app_version }}"
        source: pull
        force_source: yes

    - name: Start container with new version
      community.docker.docker_compose:
        project_src: "{{ docker_compose_path }}"
        state: present
        pull: yes

    - name: Wait for container to be healthy
      wait_for:
        host: localhost
        port: 3000
        delay: 5
        timeout: 60

    - name: Display completion message
      debug:
        msg: "Netflix Clone successfully updated to version {{ app_version }}"
